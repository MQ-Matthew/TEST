<extend name="Layout/ins_page" />
<block name="content">
    {:W('PageHeader/simple',array('name'=>'申请标题：'.$vo['name'].'，发起日期：'.date("Y-m-d ", $vo['create_time'])))} 
    <div class="operate panel panel-default">
     <div class="panel-body">
      <div class="pull-left">
       <a onclick="go_return_url();" class="btn btn-sm btn-primary">返回</a>
       <a onclick="del();"  class="btn btn-sm btn-danger">删除</a>
   </div>

   

    <div class="pull-right">
        <if condition="$vo.step eq '' ">
            <a onclick="create_flow_log();"  class="btn btn-sm btn-primary"> 开始审批流程</a>
        </if>
        <if condition="$vo.step eq 40 ">
        <a onclick="confirm_sheet();" class="btn btn-sm btn-primary hidden-xs">审批单</a>
        </if>
    </div>
</div>
</div>
    <form method='post' id="form_data" class="well form-horizontal">
        <div class="form-group">
            <!-- <label class="col-sm-2 control-label" for="name">结清单标题*：</label> -->
            <!-- <div class="col-sm-7"> -->
                
                <h3 align="center">{$vo.name}</h3>
            <!-- </div> -->
        </div>
        
        <div class="form-group">
            <!-- <label class="col-sm-2 control-label" for="title" >结清单表头*：</label> -->
            <!-- <div class="col-sm-7" > -->
                
                <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$vo.title}</p>
            <!-- </div> -->
        </div>
        <div class="input-group ">
            <input class="form-control" name="agent_name"  id="agent_name" type="text" readonly="readonly" value="{$vo.user_name}" />
            <input name="agent" id="agent" type="hidden"/>
            <div class="input-group-btn">
                <a class="btn btn-sm btn-primary" onclick="select_agent();" > <i class="fa fa-search" ></i> </a>
                <a onclick="del_agent()"  class="btn btn-sm btn-danger">清除</a>
            </div>
        </div>
        <!-- <div class="form-group">
            <label class="col-sm-2 control-label" for="type">类型*：</label>
            <div class="col-sm-7">
                <select name="type" id="type" class="form-control">
                    <option value="">请选择</option>
                    <option  value="1">北京市环境保护监测中心内部调动结清通知单（内部调动使用）</option>
                    <option  value="2">北京市环境保护监测中心调出人员结清通知单（解除合同使用）</option>
                    <option  value="3">北京市环境保护监测中心调出人员结清通知单（退休使用）</option>
                    <option  value="4">北京市环境保护监测中心调出人员结清通知单（系统内部调出使用）</option>
                    <option  value="5">北京市环境保护监测中心外派人员结清通知单（外派人员使用）</option>
                    <option  value="6">北京市环境保护监测中心外派人员结清通知单（援疆援藏使用）</option>
                </select>
            </div>
        </div> -->
<if condition="$vo.type eq 1 "> 
    <div   id="tbcontent">
        <input type="hidden" name="tb_content" id="tb_content">
    <div class="panel panel-default">
        <div class="panel-heading">
            北京市环境保护监测中心内部调动结清通知单（内部调动使用）
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="5%">序号</th>
                            <th width="10%">单位</th>
                            <th width="30%">相关事项</th>
                            <th width="25%">结、交情况</th>
                            <th width="15%">科室负责人签字</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                        <volist name="list" id="v" key="k">
                        
                        <tr>
                        <td>{$k}</td>
                            <td>{$v.dept_name}</td>
                            <td>{$v.matter}</td>
                            <td>{$v.comment}</td>
                            <td>{$v.approver}</td>  
                        </tr>

                        </volist>
                    </tbody>
                    </table>
            </div>
            
            <!-- /.table-responsive -->
        </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
    
    
<elseif condition="$vo.type eq 2"/>
<div   id="tbcontent">
        <input type="hidden" name="tb_content" id="tb_content">
    <div class="panel panel-default">
        <div class="panel-heading">
            北京市环境保护监测中心调出人员结清通知单（解除合同使用）
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="5%">序号</th>
                            <th width="10%">单位</th>
                            <th width="30%">相关事项</th>
                            <th width="25%">结、交情况</th>
                            <th width="15%">科室负责人签字</th>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="list" id="v" key="k">
                        
                        <tr>
                        <td>{$k}</td>
                            <td>{$v.dept_name}</td>
                            <td>{$v.matter}</td>
                            <td>{$v.comment}</td>
                            <td>{$v.approver}</td>  
                        </tr>

                        </volist><tr>
                        <td>9</td>
                            <td>住址、邮编、联系电话</td>
                            <td>{$vo.place}</td>
                            <td></td>
                            <td></td>
                                
                        </tr><tr>
                        <td>10</td>
                            <td>身份证号</td>
                            <td>{$vo.idcard}</td>
                            <td></td>
                            <td></td>
                                
                        </tr>                                       
                    </tbody>
                    </table>
            </div>
            
            <!-- /.table-responsive -->
        </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
<elseif condition="$vo.type eq 3"/>
<div   id="tbcontent">
        <input type="hidden" name="tb_content" id="tb_content">
    <div class="panel panel-default">
        <div class="panel-heading">
            北京市环境保护监测中心调出人员结清通知单（退休使用）
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="5%">序号</th>
                            <th width="10%">单位</th>
                            <th width="30%">相关事项</th>
                            <th width="25%">结、交情况</th>
                            <th width="15%">科室负责人签字</th>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="list" id="v" key="k">
                        
                        <tr>
                        <td>{$k}</td>
                            <td>{$v.dept_name}</td>
                            <td>{$v.matter}</td>
                            <td>{$v.comment}</td>
                            <td>{$v.approver}</td>  
                        </tr>

                        </volist><tr>
                        <td>10</td>
                            <td>住址、邮编、联系电话</td>
                            <td>{$vo.place}</td>
                            <td></td>
                            <td></td>
                                
                        </tr><tr>
                        <td>11</td>
                            <td>身份证号</td>
                            <td>{$vo.idcard}</td>
                            <td></td>
                            <td></td>
                                
                        </tr>                                       
                    </tbody>
                    </table>
            </div>
            </div>
            <!-- /.table-responsive -->
        </div>
        
        <!-- /.panel-body -->
    </div>
<elseif condition="$vo.type eq 4"/>
    <div   id="tbcontent">
        <input type="hidden" name="tb_content" id="tb_content">
    <div class="panel panel-default">
        <div class="panel-heading">
            北京市环境保护监测中心调出人员结清通知单（系统内部调出使用）
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="5%">序号</th>
                            <th width="10%">单位</th>
                            <th width="30%">相关事项</th>
                            <th width="25%">结、交情况</th>
                            <th width="15%">科室负责人签字</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                        <volist name="list" id="v" key="k">
                        
                        <tr>
                        <td>{$k}</td>
                            <td>{$v.dept_name}</td>
                            <td>{$v.matter}</td>
                            <td>{$v.comment}</td>
                            <td>{$v.approver}</td>  
                        </tr>

                        </volist>

                        <tr>
                        <td>10</td>
                            <td>住址、邮编、联系电话</td>
                            <td>{$vo.place}</td>
                            <td></td>
                            <td></td>
                                
                        </tr><tr>
                        <td>11</td>
                            <td>身份证号</td>
                            <td>{$vo.idcard}</td>
                            <td></td>
                            <td></td>
                                
                        </tr>                                       
                    </tbody>
                    </table>
            </div>
            
            <!-- /.table-responsive -->
        </div>
        </div>
        <!-- /.panel-body -->
    </div>
<elseif condition="$vo.type eq 5"/>
<div   id="tbcontent">
        <input type="hidden" name="tb_content" id="tb_content">
    <div class="panel panel-default">
        <div class="panel-heading">
            北京市环境保护监测中心外派人员结清通知单（外派人员使用）
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="5%">序号</th>
                            <th width="10%">单位</th>
                            <th width="30%">相关事项</th>
                            <th width="25%">结、交情况</th>
                            <th width="15%">科室负责人签字</th>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="list" id="v" key="k">
                        
                        <tr>
                        <td>{$k}</td>
                            <td>{$v.dept_name}</td>
                            <td>{$v.matter}</td>
                            <td>{$v.comment}</td>
                            <td>{$v.approver}</td>  
                        </tr>

                        </volist>
                    </tbody>
                    </table>
            </div>
            
            <!-- /.table-responsive -->
        </div>
        </div>
        <!-- /.panel-body -->
    </div>
<else />
    <div class="panel panel-default">
        <div   id="tbcontent">
        <input type="hidden" name="tb_content" id="tb_content">
        <div class="panel-heading">
            北京市环境保护监测中心外派人员结清通知单（援疆援藏使用）
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th width="5%">序号</th>
                            <th width="10%">单位</th>
                            <th width="30%">相关事项</th>
                            <th width="25%">结、交情况</th>
                            <th width="15%">科室负责人签字</th>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="list" id="v" key="k">
                        
                        <tr>
                        <td>{$k}</td>
                            <td>{$v.dept_name}</td>
                            <td>{$v.matter}</td>
                            <td>{$v.comment}</td>
                            <td>{$v.approver}</td>  
                        </tr>

                        </volist>
                    </tbody>
                    </table>
            </div>
            
            <!-- /.table-responsive -->
        </div>
        </div>
        <!-- /.panel-body -->
    </div>
</if>
<!-- {$vo.tb_content}  -->
</form>
</block>
<block name="js">
    <script type="text/javascript">
        $(function(){
           if($("#fist_flow_step").val() != 40){
                $("#second_post").remove();
           }
        });
        function create_flow_log($flow_type) {
            var t = 5;
            var int = setInterval(function(){
                t--;
                if(t == 0)
                {

                    $("#fist_post").html("提交初审");
                    $("#fist_post").attr("onclick","fist_send_flow(75)");
                    clearInterval(int);
                }
                else
                {
                    $("#fist_post").attr("onclick", "javascript:alert('不能重复提交！')");
                    $("#fist_post").html("重新提交("+t+")")
                }
            }, 1000);

            ui_confirm('确定要提交到结清单审批流程吗?', function(){
                $("#tb_content").val($("#tbcontent").html());
                var content = $("#tb_content").val();
                sendAjax("{:U('create_flow_log')}", "id={$vo['id']}&content="+content +"", function(data){
                    if(data.status)
                    {
                        ui_alert(data.info, function(){
                            window.location.href = data.url; 
                        });
                    }
                });
            });
        }

        function second_send_flow($flow_type) {

            var t = 10;
            var int = setInterval(function(){
                t--;
                if(t == 0)
                {
                    $("#second_post").html("提交复审");
                    $("#second_post").attr("onclick","second_send_flow(76)");
                    clearInterval(int);
                }
                else
                {
                    $("#second_post").attr("onclick", "javascript:alert('不能重复提交！')");
                    $("#second_post").html("重新提交("+t+")")
                }
            }, 1000);

            ui_confirm('确定要提交到每个科室主任进行结清单复审流程吗?', function(){
                sendAjax("{:U('second_send_flow')}", 'id={$vo['id']}&flow_type='+$flow_type, function(data){
                    if(data.status)
                    {
                        ui_alert(data.info, function(){
                            go_return_url();
                        });
                    }
                });
            });
        }
      

      function view_fist_flow() {
          window.location = "{:U('Flow/read','id='.$vo['fist_flow_id'].'&fid='.$folder)}";
      }

      function view_second_flow() {
          window.location = "{:U('flow_detail','id='.$vo['id'])}";
      }

      function bonus_user() {
          window.location = "{:U('bonus_user','id='.$vo['id'])}";
      }

      function confirm_sheet() {
          window.location = "{:U('confirm_sheet','id='.$vo['id'])}";
      }
      function select_agent() {
            // if ($("#id").val().length < 1) {
            //     ui_error("请选择用户");
            //     return false;
            // }
            winopen("{:U('popup/agent')}", 560, 470);
        }

      function del() {        
        ui_confirm('确定要删除吗?', function(){
            sendAjax("{:U('del')}", 'id={$vo.id}', function(data){
                if(data.status)
                {
                    ui_alert(data.info, function(){
                        go_return_url();
                    });
                }
            });
        });
    }

    

    
</script>
</block>